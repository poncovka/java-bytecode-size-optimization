%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Java Virtual Machine}\label{JVM}

Architektura Javy se podle Vennerse \cite{Venners:InsideJVM} skládá z programovacího jazyka Java, formátu instrukčního souboru, aplikačního programového rozhraní Java Application Programming Interface (Java API) a virtuálního stroje Java Virtual Machine (JVM). Pro psaní zdrojových kódů a jejich spouštění je zapotřebí všech těchto částí.
Zdrojový kód zapsaný v programovacím jazyce Java je uložený v souboru s příponou \texttt{.java} (dále \texttt{java} souboru). Tento kód je při kompilaci převeden na mezikód, tzv. bajtkód, a uložen v souborech s příponou \texttt{.class} (dále \texttt{class} souborech). Bajtkód lze spustit pomocí virtuálního stroje, který má přístup k Java API. O tomto stroji lze  hovořit z hlediska abstraktní specifikace nebo konkrétní implementace. Konkrétní implementace je závislá na daném systému a hardwaru, ale jednotná interpretace \texttt{class} souborů napříč platformami je zajištěna dodržením specifikace a platformově nezávislým formátem \texttt{class} souborů. Vzhledem k zaměření práce se v této kapitole zabývám abstraktní specifikací JVM dle dokumentu \cite{Lindholm:JVM}. 

\section{Datové typy a hodnoty}\label{JVMTypes}

Datové typy a hodnoty podporované JVM jsou znázorněné na obrázku \ref{figTypes}. Celá čísla jsou reprezentovaná datovými typy \texttt{byte} o délce 8 bitů, \texttt{short} o délce 16 bitů, \texttt{int} o délce 32 bitů nebo \texttt{long} o délce 64 bitů. Pro čísla s plovoucí čárkou jsou definovány typy \texttt{float} o 32 bitech a \texttt{double} o 64 bitech. Typ \texttt{boolean} reprezentuje pravdivostní hodnoty pravda a nepravda. Typ \texttt{returnAddress} reprezentuje ukazatel na instrukci v instrukčním souboru.

Znaky a řetězce jsou v Javě kódované podle standardu Unicode v kódování UTF-16, kde jeden znak je kódovaný jednou nebo dvěma kódovými jednotkami. Kódovou jednotku reprezentuje typ \texttt{char}. Jedná se o 16-bitové nezáporné číslo. Řetězec je pak reprezentovaný pomocí pole hodnot typu \texttt{char}. V instrukčním souboru jsou řetězcové konstanty kódované v modifikovaném kódování UTF-8. 

Typ \texttt{reference} označuje referenční datový typ a reprezentuje referenci na dynamicky vytvořený objekt. Podle toho, zda objekt je instancí třídy, pole nebo instancí třídy či pole, které implementují nějaké rozhraní, se rozlišuje typ reference. Hodnotou typu \texttt{reference} může být též speciální hodnota \texttt{null}, tedy reference na žádný objekt. 


% TODO vylepšit, ošklivé
\input{fig/types}


Instrukční sada JVM je omezená a nenabízí u všech instrukcí podporu pro všechny datové typy. Celá čísla jsou primárně reprezentovaná datovými typy \texttt{int} a \texttt{long} a případně přetypovaná na jeden z typů \texttt{byte}, \texttt{short} či \texttt{char}. Pro datový typ \texttt{boolean} existuje jen podpora pro přetypování a pro vytvoření pole hodnot typu \texttt{boolean}. Pro výpočet logických výrazů se používá typ \texttt{int} s hodnotami 0 a 1.


\section{Paměťové oblasti}\label{JVMData}

JVM pracuje s několika typy paměťových oblastí. Velikosti těchto oblastí mohou být pevně dané, nebo se mohou měnit dynamicky podle potřeby. Při spuštění JVM vzniká halda a oblast metod. Halda je paměť určená pro alokaci instancí tříd a polí. Alokovanou paměť nelze dealokovat explicitně. Haldu automaticky spravuje tzv. \textit{garbage collector}. Oblast metod slouží k ukládání kompilovaného kódu. Pro každou načtenou třídu se do této paměti ukládají struktury definující tuto třídu. Jednou z těchto struktur je tzv. \textit{run-time constant pool}. Jedná se o tabulku konstant z \texttt{class} souboru, kde jsou symbolické reference na třídy, metody a členské proměnné nahrazeny konkrétními referencemi. Více se o tabulce konstant zmiňuje kapitola \ref{FormatConstants}. 

Každá aplikace je spuštěna v samostatném vlákně a při běhu mohou vznikat a zanikat i další vlákna. Všechna taková vlákna sdílí přístup k haldě a oblasti metod. Navíc má každé vlákno k dispozici vlastní \texttt{pc} registr a zásobník rámců. V \texttt{pc} registru je uchováván ukazatel na aktuálně vykonávanou instrukci, není-li aktuálně vykonávaná metoda nativní. Zásobník rámců obsahuje data zavolaných metod. Při každém volání metody je vytvořen nový rámec. Rámec má vlastní pole lokálních proměnných a operační zásobník. V poli lokálních proměnných se uchovávají hodnoty parametrů a lokálních proměnných. Hodnoty lze vkládat na operační zásobník, provádět nad nimi výpočty a ukládat zpět do pole. Operační zásobník slouží k předávání operandů instrukcím a k uchovávání mezivýsledků. Podílí se také na předávání parametrů a návratových hodnot.

Před voláním metody je třeba nejprve vložit parametry na operační zásobník aktuálního rámce. Zavoláním metody se vytvoří nový rámec a umístí se na vrchol zásobníku rámců. Parametry se následně přesunou z operačního zásobníku předchozího rámce do pole lokálních proměnných nového rámce. Registr \texttt{pc} se nastaví na první instrukci volané metody a začnou se vykonávat jednotlivé instrukce. Při návratu z metody je návratová hodnota umístěná na vrcholu operačního zásobníku, vrací-li metoda nějakou hodnotu. Tato hodnota je přesunuta na operační zásobník předcházejícího rámce a aktuální rámec je ze zásobníku rámců odstraněn. Dojde k obnovení stavu volající metody. Registr \texttt{pc} je nastaven na index instrukce, která bezprostředně následuje za instrukcí volající metodu. Pokud je metoda ukončena vyvoláním nezachycené výjimky, pak k předání hodnoty nedochází. Aktuální rámec je odstraněn a výjimka je znovu vyvolaná ve volající metodě. Zpracování výjimek je více vysvětleno v kapitole \ref{FormatMethod}.


Nejmenší jednotka, se kterou pracuje operační zásobník, je 32-bitová hodnota. Hodnoty většiny datových typů lze vyjádřit pomocí jedné jednotky, ale hodnoty typů \texttt{long} a \texttt{double} je třeba reprezentovat dvěma jednotkami. S takovou dvojicí je třeba vždy manipulovat jako s celkem. Datový typ hodnoty na zásobníku je daný instrukcí, která ho tam vložila, a na hodnotu nelze nahlížet jinak. Hloubka operačního zásobníku je určená počtem jednotek na zásobníku. Proto se o jednotce dále zmiňuji jako o jednotce hloubky zásobníku.

Lokální proměnná v poli lokálních proměnných je 32-bitová hodnota. Proměnnou lze adresovat pomocí indexu do pole, kde pole je indexováno od nuly. Lokální proměnná může být typu \texttt{byte}, \texttt{short}, \texttt{int}, \texttt{char}, \texttt{float}, \texttt{boolean}, \texttt{reference} nebo \texttt{returnAddress}. Hodnoty typu \texttt{long} a \texttt{double} jsou uchovávané pomocí dvojice lokálních proměnných. V tom případě k adresaci slouží nižší z indexů a na větší index se nesmí přistupovat. 


\section{Kontrola instrukčního souboru}\label{JVMVerification}

Při načítání \texttt{class} souboru je ověřeno správné formátování tak, jak je popsáno v kapitole \ref{Format}. Jsou zkontrolovány první čtyři bajty souboru, předdefinované atributy musí být správné délky, názvy a typy tříd, rozhraní, metod a proměnných musí být validní, indexy do tabulky konstant musí adresovat správný typ položky. Dále jsou kladena jistá omezení na kód metod. Mimo jiné, argumenty instrukcí musí mít správný typ a musí být správného počtu, integrita hodnot typu \texttt{long} a \texttt{double} nemůže být nikdy narušena, z hodnotě lokální proměnné se nesmí přistupovat před inicializací proměnné, nesmí dojít k načtení hodnoty z prázdného zásobníku a všechny metody musí byt ukončené \texttt{return} instrukcí. Verifikace těchto omezení se provádí pomocí typové kontroly nebo typové inference. Díky tomu se kontroly omezení nemusí provádět za běhu.


%=========================================================================
